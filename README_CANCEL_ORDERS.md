# 批量撤销订单工具

## 功能说明

`cancel_all_orders.py` 是一个批量撤销今日所有订单的工具脚本。

## 使用方法

### 运行脚本

```bash
cd /Users/txink/Documents/code/playwright
PYTHONPATH=/Users/txink/Documents/code/playwright python3 cancel_all_orders.py
```

### 工作流程

1. **连接 LongPort Broker**
   - 自动加载配置
   - 初始化交易接口

2. **获取今日订单**
   - 自动获取所有当日订单
   - 显示订单汇总表格

3. **过滤可撤销订单**
   - 自动识别可撤销的订单状态：
     - `NotReported` - 待报
     - `ReplacedNotReported` - 待报修改
     - `PendingReplace` - 修改待报
     - `NewOrder` - 已报
     - `PartiallyFilled` - 部分成交
     - `RejectedCancel` - 撤销已拒绝
   
   - 排除不可撤销的订单状态：
     - `Filled` - 已成交
     - `Cancelled` - 已撤销
     - `Rejected` - 已拒绝
     - `Expired` - 已过期

4. **确认操作**
   - 显示可撤销订单数量
   - 等待用户确认（输入 `yes` 或 `y`）

5. **批量撤销**
   - 逐个撤销订单
   - 显示每个订单的撤销结果
   - 使用带红色边框的表格展示撤销详情

6. **结果汇总**
   - 显示成功、失败、跳过的统计

## 输出示例

### 1. 订单列表

```
📊 正在获取今日所有订单...

                    今日订单 (共 85 个)
┏━━━━━━━━━━━━━━━━━━━━━━┳━━━┳━━━┳━━━━━━━━┳━━━━━━━━━┳━━━━━━━━━━━━┓
┃ 期权                 ┃ … ┃ … ┃ 价格   ┃ 总价    ┃ 状态       ┃
┣━━━━━━━━━━━━━━━━━━━━━━╋━━━╋━━━╋━━━━━━━━╋━━━━━━━━━╋━━━━━━━━━━━━┫
┃ AAPL 260202 $252.5   ┃ … ┃ 1 ┃ $2.50  ┃ $250.00 ┃ NewOrder   ┃
┃ AAPL 260202 $252.5   ┃ … ┃ 2 ┃ $4.50  ┃ $900.00 ┃ NewOrder   ┃
...
┗━━━━━━━━━━━━━━━━━━━━━━┻━━━┻━━━┻━━━━━━━━┻━━━━━━━━━┻━━━━━━━━━━━━┛
```

### 2. 可撤销订单提示

```
📝 发现 21 个可撤销订单 (共 85 个订单)

⚠️  确认要撤销这些订单吗？
   输入 'yes' 或 'y' 确认撤销
   输入其他任何内容取消操作

请输入:
```

### 3. 撤销进度

```
🔄 开始撤销订单...

[1/21] 撤销订单: 1234567890 (AAPL 260202 $252.5 CALL)
                    AAPL 260202 $252.5 CALL
┏━━━━━━━━━━━━┳━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━┓
┃ 订单ID     ┃ 1234567890                            ┃
┃ 期权       ┃ AAPL 260202 $252.5 CALL               ┃
┃ 操作方向   ┃ BUY                                   ┃
┃ 数量       ┃ 1                                     ┃
┃ 价格       ┃ $2.50                                 ┃
┃ 总价       ┃ $250.00                               ┃
┗━━━━━━━━━━━━┻━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━┛
```

### 4. 结果汇总

```
============================================================
📊 撤销结果汇总
============================================================

总订单数: 85
可撤销订单: 21
✅ 成功撤销: 21
⚠️  跳过: 0
❌ 失败: 0

✅ 成功撤销 21 个订单
```

## 安全特性

- ✅ **确认机制**：撤销前必须手动确认
- ✅ **智能过滤**：自动排除不可撤销的订单
- ✅ **详细日志**：记录每个订单的撤销状态
- ✅ **错误处理**：捕获并报告撤销失败的订单
- ✅ **可中断**：可以使用 Ctrl+C 随时中断操作

## 注意事项

1. **模拟账户模式**
   - 脚本默认连接到模拟账户（Paper Trading）
   - 如需使用真实账户，需修改配置

2. **订单状态**
   - 已完成的订单无法撤销
   - 已撤销的订单会被自动跳过

3. **权限要求**
   - 需要 LongPort 账户的交易权限
   - 确保 `auto_trade` 配置已启用

## 相关文件

- `broker/longport_broker.py` - LongPort 交易接口
- `broker/order_formatter.py` - 订单格式化输出
- `broker/config.yaml` - LongPort 配置文件

## 故障排除

### 问题：没有可撤销的订单

**原因**：所有订单已完成、已撤销或已拒绝

**解决**：正常情况，无需操作

### 问题：初始化 broker 失败

**原因**：配置文件错误或网络连接问题

**解决**：检查 `broker/config.yaml` 配置

### 问题：撤销失败

**原因**：订单状态已变更或网络问题

**解决**：查看错误日志，必要时手动撤销
