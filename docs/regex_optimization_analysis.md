# 正则表达式优化分析报告

基于 `data/parsed_messages.json` 的解析结果分析

生成时间: 2026-02-06

## 统计概览

- **总消息数**: 225
- **✅ 解析成功且完整**: 132 (58.7%)
- **⚠️ 解析成功但不完整**: 29 (12.9%)
- **❌ 解析失败**: 64 (28.4%)

## 问题分类

### 一、不完整消息问题（⚠️ 29条）

#### 问题1: 日期格式 `M/D` 在ticker和strike之间时无法识别

**典型案例**:
```
合约：QQQ 11/20 614c 入场价：1.1 备注：小仓位
合约：QQQ 11/20 609P 入场价：1.5 备注：小仓位
合约： $QQQ 11/20 610C 入场： 0.75
合约：QQQ 11/21 595C 入场价：1.25 小仓位
合约：QQQ 12/02 623C 入场价：1.1
```

**当前解析结果**: 
- ✅ ticker: QQQ
- ✅ strike: 614.0
- ✅ option_type: CALL
- ❌ expiry: None
- ❌ symbol: None

**原因分析**:
- 当前 `OPEN_PATTERN_2` 期望格式: `QQQ 614c 11/20 1.1` (日期在后)
- 实际格式: `QQQ 11/20 614c 1.1` (日期在中间)
- `OPEN_PATTERN_2` 的日期捕获组是可选的: `(?:\d{1,2}/\d{1,2}\s+)?`，但这个可选组在 strike 之前，不在正确位置

**建议修复**:
创建新模式 `OPEN_PATTERN_7` 或修改 `OPEN_PATTERN_2`:
```python
# 新模式: ticker + 日期 + strike + c/p + 价格
OPEN_PATTERN_7 = re.compile(
    r'([A-Z]{2,5})\s+'
    r'(\d{1,2}/\d{1,2}|\d{1,2}月\d{1,2}日?)\s+'  # 日期（必需）
    r'(\d+(?:\.\d+)?)\s*'  # 行权价
    r'[cCpP](?:all|ut)?s?\s*'  # c/p/call/put
    r'(?:入场价?[：:])?\s*'
    r'((?:\d+(?:\.\d+)?|\.\d+)(?:-(?:\d+(?:\.\d+)?|\.\d+))?)',  # 价格或价格区间
    re.IGNORECASE
)
```

**影响**: 可修复约 20+ 条不完整消息

---

### 二、解析失败问题（❌ 64条）

#### 分类统计:
- **纯价格信息** (30条): 如 "1.2-1.3开始减三分之一" - 依赖上下文，属于正常失败
- **纯说明/提示** (16条): 如 "小仓位"、"力度不够" - 注释性内容，属于正常失败
- **应该能解析但失败** (7条): 需要修复
- **其他** (11条): 复杂格式或混合信息

#### 问题2: 中文"看涨期权"/"看跌期权"不支持

**典型案例**:
```
合约： $QQQ 12月17日 608看涨期权 入场： 0.7
MCD - 下周到期 $327.5 看涨期权 $2.75
```

**原因分析**:
- 所有模式只匹配英文 `call`/`put`/`CALLS`/`PUTS`
- 不支持中文 `看涨期权`/`看跌期权`

**建议修复**:
在相关模式中添加中文支持:
```python
OPEN_PATTERN_8 = re.compile(
    r'([A-Z]{2,5})\s*[-–]?\s*'
    r'(?:(下周|本周)(?:到期)?)??\s*'  # 可选的相对日期
    r'\$?(\d+(?:\.\d+)?)\s*'  # 行权价
    r'(看涨期权|看跌期权|CALLS?|PUTS?)\s*'  # 中文或英文
    r'\$?((?:\d+(?:\.\d+)?|\.\d+)(?:-(?:\d+(?:\.\d+)?|\.\d+))?)',  # 价格
    re.IGNORECASE
)

# 或者修改现有模式，在option_type匹配中添加中文
# (CALLS?|PUTS?|看涨期权|看跌期权)
```

**影响**: 可修复约 2-3 条失败消息

---

#### 问题3: "下周的"格式中的"的"字未处理

**典型案例**:
```
APLD - $40 CALLS下周的 $1.28
AMD - $260 CALLS 下周的$4.45
```

**原因分析**:
- 当前模式不支持"下周的"、"本周的"这种带"的"字的格式
- `OPEN_PATTERN_1` 匹配 `CALLS?\s*...` 后直接期望日期或价格

**建议修复**:
```python
OPEN_PATTERN_1 = re.compile(
    r'([A-Z]{2,5})\s*[-–]?\s*\$?(\d+(?:\.\d+)?)\s*'
    r'(?:(?:ITM|OTM|ATM)\s+)?'
    r'(CALLS?|PUTS?)\s*'
    r'(?:(本周|下周|这周|当周|今天)(?:的)?\s*|'  # 添加"的"字支持
    r'(?:EXPIRATION\s+)?(\d{1,2}/\d{1,2}|\d{1,2}月\d{1,2}日?|1月\d{1,2}|2月\d{1,2})\s*|'
    r'(?:EXPIRATION\s+)?(NEXT\s+WEEK|THIS\s+WEEK)\s*)?'
    r'\$?((?:\d+(?:\.\d+)?|\.\d+)(?:-(?:\d+(?:\.\d+)?|\.\d+))?)',
    re.IGNORECASE
)
```

**影响**: 可修复约 2-3 条失败消息

---

#### 问题4: 带详细期权信息的卖出指令不支持

**典型案例**:
```
0.47 出rivn 19.5 call
0.4也减点 rivn 20call 在拿点博价内
1.65附近 46 call 剩余都出了
4.15-4.2出 amzn亚马逊call 有点慢
```

**原因分析**:
- 当前 `TAKE_PROFIT` 模式只提取价格和比例，不提取期权详细信息
- 这种消息应该被识别为带ticker/strike/type的卖出指令

**建议修复**:
创建新的 `TAKE_PROFIT_PATTERN_11`:
```python
# 格式: 价格 + 出/减 + ticker + strike + call/put
TAKE_PROFIT_PATTERN_11 = re.compile(
    r'((?:\d+(?:\.\d+)?|\.\d+)(?:-(?:\d+(?:\.\d+)?|\.\d+))?)\s*'  # 价格或价格区间
    r'(?:附近)?\s*'
    r'(?:也)?(?:出|减)(?:点|了)?\s*'
    r'([A-Z]{2,5})\s*'  # ticker
    r'(\d+(?:\.\d+)?)\s*'  # strike
    r'(call|put)s?',  # option type
    re.IGNORECASE
)
```

**影响**: 可修复约 3-5 条失败消息，且提高卖出指令的完整性

---

#### 问题5: 价格在前的特殊格式支持不全

**典型案例**:
```
$XOM 1/16 $127 call 0.8-0.85 小仓位
```

**原因分析**:
- `OPEN_PATTERN_5` 支持 `$ticker ... $strike call $price` 格式
- 但日期 `1/16` 在中间位置时可能匹配失败

**建议修复**:
检查并增强 `OPEN_PATTERN_5` 的日期位置灵活性:
```python
OPEN_PATTERN_5 = re.compile(
    r'\$([A-Z]{2,5})\s+'
    r'(?:(\d{1,2}/\d{1,2}|\d{1,2}月\d{1,2}日?)\s+)?'  # 日期可选，在前面
    r'(?:(call|put)s?\s+)?'  # call/put可以在前面
    r'(?:(本周|下周|这周|当周|今天)(?:的)?\s*)?'  # 支持相对日期
    r'\$?(\d+(?:\.\d+)?)\s+'  # 行权价
    r'(?:(call|put)s?\s+)?'  # call/put也可以在后面
    r'\$?((?:\d+(?:\.\d+)?|\.\d+)(?:-(?:\d+(?:\.\d+)?|\.\d+))?)',  # 价格
    re.IGNORECASE
)
```

**影响**: 可修复 1-2 条失败消息

---

## 优化优先级

### 🔥 高优先级（立即修复）

1. **问题1: 日期在中间的格式** - 影响 20+ 条消息
   - 新增 `OPEN_PATTERN_7` 支持 `ticker + M/D + strike + c/p + 价格`

### 🔶 中优先级（建议修复）

2. **问题3: "的"字支持** - 影响 2-3 条消息
   - 修改 `OPEN_PATTERN_1` 添加 `(?:的)?`

3. **问题2: 中文期权类型** - 影响 2-3 条消息
   - 新增 `OPEN_PATTERN_8` 或修改现有模式支持"看涨期权"/"看跌期权"

4. **问题4: 带详细信息的卖出** - 影响 3-5 条，且提高完整性
   - 新增 `TAKE_PROFIT_PATTERN_11`

### 🔵 低优先级（可选优化）

5. **问题5: 特殊价格格式** - 影响 1-2 条
   - 增强 `OPEN_PATTERN_5`

---

## 预期效果

实施所有高优先级和中优先级修复后:
- ✅ 成功率: 58.7% → **约 70-75%**
- ⚠️ 不完整率: 12.9% → **约 5-8%**
- ❌ 失败率: 28.4% → **约 20%** (剩余主要是正常的纯说明/提示类消息)

---

## 实施建议

1. 按优先级顺序添加新模式
2. 每添加一个模式后重新运行测试验证效果
3. 确保新模式不会误匹配其他格式（避免假阳性）
4. 更新单元测试覆盖新格式
5. 更新 `CHANGELOG.md` 记录改进
