# 订单格式化输出指南

## 概述

系统现在使用彩色表格展示订单信息，提供更直观、易读的输出格式。

## 功能特性

### 🎨 彩色标识

#### 文字颜色
- **BUY (买入)** - 绿色粗体 ✅
- **SELL (卖出)** - 红色粗体 ❌
- **CANCEL (撤销)** - 黄色粗体 ⚠️
- **修改项** - 黄色高亮（如 `1 → 2`）

#### 表格边框样式（粗体边框 + 彩色）
- **购买订单（BUY）** - 🔵 蓝色粗体边框
- **售卖订单（SELL）** - 🟢 绿色粗体边框
- **修改订单（MODIFY）** - 🟡 黄色粗体边框
- **撤销订单（CANCEL）** - 🔴 红色粗体边框（警示色）

**边框样式说明：**
- 所有表格使用 `box.HEAVY` 样式，边框线更粗（使用 `━` 而非 `─`）
- 修改订单和撤销订单表格无表头，更简洁
- 边框颜色与操作类型关联，直观识别

**边框优势：**
- ✅ 粗边框更醒目，快速定位关键信息
- ✅ 红色边框警示撤销操作，降低误操作风险
- ✅ 颜色关联操作类型，提升识别效率
- ✅ 统一专业的视觉风格

### 📋 表格类型

#### 1. 订单详情表 (`print_order_table`)

展示单个订单的完整信息（垂直两列格式）：

```
           AAPL 260207 $250 CALL            
┏━━━━━━━━━━━━━━┳━━━━━━━━━━━━━━━━━━━━━━━━━━━┓
┃ 字段         ┃ 值                        ┃
┡━━━━━━━━━━━━━━╇━━━━━━━━━━━━━━━━━━━━━━━━━━━┩
│ 订单ID       │ 1202580174474850304       │
│ 期权名称     │ AAPL260207C250000.US      │
│ 操作方向     │ BUY                       │ (绿色)
│ 数量         │ 2                         │
│ 价格         │ $5.00                     │
│ 总价         │ $1000.00                  │ (蓝色粗体)
│ 策略         │ 止损: $3.00               │
│ 状态         │ submitted                 │
│ 账户模式     │ 🧪 模拟                   │
│ 备注         │ 带止损的买入订单          │
└──────────────┴───────────────────────────┘
```

**关键特性：**
- ✅ 表格标题显示语义化期权名称（如 `AAPL 260207 $250 CALL`）
- ✅ 垂直两列格式：左列为字段名，右列为值
- ✅ 操作方向使用颜色标识（BUY=绿色，SELL=红色）

**包含字段：**
- 订单ID
- 期权名称
- 操作方向（彩色）
- 数量
- 价格（单价）
- 总价（蓝色粗体）
- 策略（止盈止损规则）
- 状态
- 账户模式
- 备注

**💰 价格和总价显示格式：**

价格信息拆分为两个独立字段：
```
│ 价格         │ $5.00                     │
│ 总价         │ $1000.00                  │ ← 蓝色粗体
```
- **价格**：每份合约的单价
- **总价**：合约总价值（单价 × 数量 × 100），蓝色粗体显示

**优势：**
- ✅ 信息更清晰：价格和总价分离展示
- ✅ 视觉突出：总价使用蓝色粗体，一眼看到合约价值
- ✅ 快速决策：无需心算即可了解投资金额

#### 2. 订单修改表 (`print_order_modify_table`)

**只显示有变更的字段**，修改项黄色高亮：

```
                      订单修改详情                         
┏━━━━━━━━━━━━━━┳━━━━━━━━━━━━━━━━━━━━━━┳━━━━━━━━━━━━━━━━━━━━━━┓
┃ 字段         ┃ 原值                 ┃ 新值                 ┃
┡━━━━━━━━━━━━━━╇━━━━━━━━━━━━━━━━━━━━━━╇━━━━━━━━━━━━━━━━━━━━━━┩
│ 订单ID       │ 1202580174474850304  │ 1202580174474850304  │
│ 期权名称     │ AAPL260207C250000.US │ AAPL260207C250000.US │
│ 数量         │ 1                    │ 1 → 3                │ (黄色)
│ 价格         │ $5.00                │ $5.00 → $4.50        │ (黄色)
│ 总价         │ $500.00              │ $500.00 → $1350.00   │ (黄色高亮)
│ 策略         │ 止损: $3.00          │ 止损: $2.50          │ (黄色)
└──────────────┴──────────────────────┴──────────────────────┘
ℹ️  共修改 3 个字段
```

**特点：**
- **只显示有变更的字段**（未修改的字段不显示）
- 订单ID和期权名称始终显示
- 变更项用箭头 `→` 表示
- 新值列黄色高亮
- 底部显示修改统计

**示例：只修改价格**

```
                      订单修改详情                         
┏━━━━━━━━━━━━━━┳━━━━━━━━━━━━━━━━━━━━━━┳━━━━━━━━━━━━━━━━━━━━━━┓
┃ 字段         ┃ 原值                 ┃ 新值                 ┃
┡━━━━━━━━━━━━━━╇━━━━━━━━━━━━━━━━━━━━━━╇━━━━━━━━━━━━━━━━━━━━━━┩
│ 订单ID       │ 9876543210           │ 9876543210           │
│ 期权名称     │ TSLA260214P250000.US │ TSLA260214P250000.US │
│ 价格         │ $6.00                │ $6.00 → $5.50        │ (黄色)
│ 总价         │ $1200.00             │ $1200.00 → $1100.00  │ (黄色高亮)
└──────────────┴──────────────────────┴──────────────────────┘
ℹ️  共修改 1 个字段
```
（注意：数量和策略未修改，所以不显示）

#### 3. 订单撤销表 (`print_order_cancel_table`)

展示撤销的订单信息：

```
               撤销订单详情               
┏━━━━━━━━━━━━━━┳━━━━━━━━━━━━━━━━━━━━━━━━━┓
┃ 字段         ┃ 值                      ┃
┡━━━━━━━━━━━━━━╇━━━━━━━━━━━━━━━━━━━━━━━━━┩
│ 订单ID       │ 1202580174474850306     │
│ 期权名称     │ NVDA260221C900000.US    │
│ 操作         │ CANCEL                  │ (黄色)
│ 数量         │ 2                       │
│ 价格         │ $3.00                   │
│ 总价         │ $600.00                 │ (蓝色粗体)
│ 状态         │ 已撤销                  │
│ 撤销时间     │ 2026-02-01T19:44:33.977 │
└──────────────┴─────────────────────────┘
```

#### 4. 订单列表汇总表 (`print_orders_summary_table`)

展示多个订单的摘要信息：

```
                      当日订单 (共 3 个)                             
┏━━━━━━━━━━━━━━━━━━━━━━┳━━━━━━┳━━━━━━┳━━━━━━━━┳━━━━━━━━━━┳━━━━━━━━━━━━━━━━┓
┃ 期权                 ┃ 方向 ┃ 数量 ┃ 价格   ┃ 总价     ┃ 状态           ┃
┡━━━━━━━━━━━━━━━━━━━━━━╇━━━━━━╇━━━━━━╇━━━━━━━━╇━━━━━━━━━━╇━━━━━━━━━━━━━━━━┩
│ AAPL 260202 $252.5…  │ BUY  │ 2    │ $5.00  │ $1000.00 │ Filled         │
│ TSLA 260207 $300 PUT │ SELL │ 1    │ $4.50  │ $450.00  │ NewOrder       │
│ NVDA 260214 $150…    │ BUY  │ 3    │ $3.20  │ $960.00  │ Canceled       │
└──────────────────────┴──────┴──────┴────────┴──────────┴────────────────┘
```

**特点：**
- 紧凑的表格布局
- 显示多个订单摘要
- 每个订单一行
- 方向字段彩色标识（BUY-蓝色, SELL-绿色）
- 状态完整显示（不截断），可快速识别已撤销、已成交等订单

## 策略格式化

> **注意**：策略信息在订单详情表（`print_order_table`、`print_order_search_table`）中显示，在订单汇总表（`print_orders_summary_table`）中已移除，以简化当日订单列表的显示。

止盈止损策略自动格式化：

### 固定止损
```
策略: 止损: $3.00
```

### 跟踪止损（百分比）
```
策略: 跟踪止损: 5.0%
```

### 跟踪止损（金额）
```
策略: 跟踪金额: $2.00
```

### 组合策略
```
策略: 止损: $3.00 | 跟踪止损: 5.0%
```

### 无策略
```
策略: -
```

## 消息类型

系统提供四种彩色消息：

```python
✅ 成功消息 - 绿色
❌ 错误消息 - 红色
⚠️  警告消息 - 黄色
ℹ️  信息消息 - 青色
```

## 使用示例

### Python 代码中使用

```python
from broker import LongPortBroker, load_longport_config

# 初始化
config = load_longport_config()
broker = LongPortBroker(config)

# 1. 提交订单 - 自动显示彩色表格
order = broker.submit_option_order(
    symbol="AAPL260207C250000.US",
    side="BUY",
    quantity=2,
    price=5.0,
    trigger_price=3.0,
    remark="带止损的买入订单"
)
# 输出：
# ✅ 订单提交成功
# [彩色表格显示订单详情]

# 2. 修改订单 - 自动显示修改对比表格
result = broker.replace_order(
    order_id=order['order_id'],
    quantity=3,
    price=4.5,
    trigger_price=2.5
)
# 输出：
# ✅ 订单修改成功
# [彩色表格显示修改前后对比]

# 3. 撤销订单 - 自动显示撤销详情
result = broker.cancel_order(order['order_id'])
# 输出：
# ✅ 订单撤销成功
# [彩色表格显示撤销订单详情]
```

### 独立使用格式化工具

```python
from broker.order_formatter import (
    print_order_table,
    print_order_modify_table,
    print_order_cancel_table,
    print_orders_summary_table,
    print_success_message
)

# 手动打印订单表格
order = {
    'order_id': '123456',
    'symbol': 'AAPL260207C250000.US',
    'side': 'BUY',
    'quantity': 2,
    'price': 5.0,
    'trigger_price': 3.0,
    'status': 'submitted',
    'mode': 'paper'
}

print_success_message("订单提交成功")
print_order_table(order, "订单详情")

# 打印订单修改对比
old_order = {'quantity': 1, 'price': 5.0}
new_values = {'quantity': 2, 'price': 4.5}
print_order_modify_table('123456', old_order, new_values)

# 打印订单列表
orders = [order1, order2, order3]
print_orders_summary_table(orders, "当日订单")
```

## 演示脚本

运行演示脚本查看所有格式：

```bash
cd /Users/txink/Documents/code/playwright
python3 demo_order_format.py
```

演示包括：
1. 买入订单（BUY - 绿色）
2. 卖出订单（SELL - 红色）
3. 订单修改（修改项黄色高亮）
4. 订单撤销（CANCEL - 黄色）
5. 订单列表汇总
6. 各种消息类型

## 技术实现

### 依赖库

使用 `rich` 库实现彩色表格输出：

```bash
pip3 install rich>=13.0.0
```

### 核心模块

- `broker/order_formatter.py` - 订单格式化工具
- `broker/longport_broker.py` - 集成格式化输出

### 颜色配置

```python
# 操作方向颜色
BUY  -> "bold green"
SELL -> "bold red"
CANCEL -> "bold yellow"

# 修改项颜色
变更值 -> "bold yellow"

# 消息颜色
成功 -> "bold green"
错误 -> "bold red"
警告 -> "bold yellow"
信息 -> "bold cyan"
```

## 兼容性

### 终端支持

- ✅ macOS Terminal
- ✅ iTerm2
- ✅ Linux 终端
- ✅ Windows Terminal
- ⚠️  某些旧版终端可能不显示颜色

### 管道和重定向

当输出重定向到文件或通过管道传输时，彩色代码会自动移除，保证兼容性。

```bash
# 颜色会自动移除
python3 test.py > output.txt
python3 test.py | less
```

## 最佳实践

1. **订单提交后自动显示表格** - 无需额外代码
2. **修改项自动高亮** - 一目了然看到变化
3. **使用适当的表格类型** - 根据场景选择
4. **保持表格简洁** - 避免过多信息

## 常见问题

### Q: 为什么看不到颜色？

A: 可能原因：
- 终端不支持彩色输出
- 输出被重定向到文件
- 通过管道传输

### Q: 如何禁用彩色输出？

A: 设置环境变量：
```bash
export NO_COLOR=1
python3 your_script.py
```

### Q: 表格太宽显示不完整？

A: Rich 会自动调整表格宽度适应终端。如果仍然有问题，可以：
- 扩大终端窗口
- 使用订单列表汇总表（更紧凑）

## 更新日志

### 2026-02-01
- ✅ 新增彩色表格输出
- ✅ BUY/SELL/CANCEL 颜色标识
- ✅ 订单修改对比表格（黄色高亮）
- ✅ 策略格式化显示
- ✅ 完整的演示脚本

## 相关文档

- [订单管理功能文档](./order_management.md)
- [长桥集成指南](../doc/LONGPORT_INTEGRATION_GUIDE.md)
- [Rich 库文档](https://rich.readthedocs.io/)
