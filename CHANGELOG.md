# 更新日志

## [2.4.11] - 2026-02-01

### 📊 订单汇总表格优化

**优化内容：**
优化 `print_orders_summary_table` 函数的显示格式：

1. **移除策略列**：当日订单不需要显示策略信息，简化表格
2. **扩展状态列**：将状态列宽度从12扩展到20，完整显示订单状态
3. **简化状态显示**：移除 "OrderStatus." 前缀，直接显示状态名称（如 "Canceled", "NewOrder"）

**优化效果：**
- ✅ 表格更简洁，信息更清晰
- ✅ 订单状态一目了然（不再被截断为 "OrderStatus…"）
- ✅ 可以快速识别已撤销、已成交等订单状态

---

## [2.4.10] - 2026-02-01

### 🛠️ 批量撤销订单工具

**新增功能：**
创建 `cancel_all_orders.py` 批量撤销今日订单的工具脚本：

1. **订单查询**：自动获取并显示今日所有订单
2. **智能过滤**：自动识别可撤销的订单（排除已完成、已撤销等状态）
3. **安全确认**：撤销前需要用户手动确认
4. **批量撤销**：逐个撤销订单并显示详细进度
5. **结果汇总**：统计成功、失败、跳过的订单数量

**可撤销的订单状态：**
- `NotReported` - 待报
- `ReplacedNotReported` - 待报修改
- `PendingReplace` - 修改待报
- `NewOrder` - 已报
- `PartiallyFilled` - 部分成交
- `RejectedCancel` - 撤销已拒绝

**使用文档：**
- 新增 `README_CANCEL_ORDERS.md` 详细使用说明

---

## [2.4.9] - 2026-02-01

### 📊 集成测试表格化显示优化

**优化内容：**
修改 `test_longport_integration.py` 测试文件，使用表格化函数替代日志输出：

1. **账户信息**：使用 `print_account_info_table()` 显示账户余额
2. **当日订单**：使用 `print_orders_summary_table()` 显示所有订单（移除10个订单的限制）
3. **持仓信息**：使用 `print_positions_table()` 显示当前持仓

**修改前（日志输出）：**
```
2026-02-01 21:08:01,510 - __main__ - INFO - 账户模式: paper
2026-02-01 21:08:01,510 - __main__ - INFO - 总资金: 766,793.34 HKD
2026-02-01 21:08:01,510 - __main__ - INFO - 可用资金: 116,751.85 HKD
```

**修改后（表格显示）：**
```
                 账户余额信息                  
┏━━━━━━━━━━━━━━━━━━━━━━┳━━━━━━━━━━━━━━━━━━━━━━┓
┃ 项目                 ┃                 金额 ┃
┣━━━━━━━━━━━━━━━━━━━━━━╋━━━━━━━━━━━━━━━━━━━━━━┫
┃ 总资产               ┃          $766,793.34 ┃
┃ 可用资金             ┃          $116,499.71 ┃
┃ 持仓市值             ┃                $0.00 ┃
┃ 冻结资金             ┃          $650,293.63 ┃
┃ 币种                 ┃                  HKD ┃
┃ 账户模式             ┃          🧪 模拟账户 ┃
┗━━━━━━━━━━━━━━━━━━━━━━┻━━━━━━━━━━━━━━━━━━━━━━┛
```

**优势：**
- ✅ 信息展示更直观清晰
- ✅ 统一使用表格格式，提升专业性
- ✅ 与其他订单相关的显示保持一致
- ✅ 便于快速识别关键信息

---

## [2.4.8] - 2026-02-01

### 📋 订单表格格式统一

**优化内容：**
- 统一所有订单表格格式为标准的两列格式（字段-值）
- `print_order_table()` 从简化的单列格式改为标准两列格式
- 与 `print_order_search_table()` 保持完全一致的显示风格

**修改前（订单提交 - 简化格式）：**
```
┏━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━┓
┃ AAPL 260202 $252.5 CALL          ┃
┃ ──────────────────────────────── ┃
┃ BUY × 1 @ $5.00 = $500.00        ┃
┃ 策略: 止损: $3.00                ┃
┃ #1202...6 | submitted | 🧪 模拟  ┃
┗━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━┛
```

**修改后（订单提交 - 标准格式）：**
```
                  AAPL 260202 $252.5 CALL                  
┏━━━━━━━━━━━━━━┳━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━┓
┃ 订单ID       ┃ 1202601196670431232                      ┃
┃ 期权         ┃ AAPL 260202 $252.5 CALL                  ┃
┃ 操作方向     ┃ BUY                                      ┃
┃ 数量         ┃ 1                                        ┃
┃ 价格         ┃ $5.00                                    ┃
┃ 总价         ┃ $500.00                                  ┃
┃ 策略         ┃ 止损: $3.00                              ┃
┃ 状态         ┃ submitted                                ┃
┃ 账户模式     ┃ 🧪 模拟账户                              ┃
┃ 备注         ┃ Test order with stop loss                ┃
┗━━━━━━━━━━━━━━┻━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━┛
```

**优势：**
- ✅ 格式统一：所有订单表格使用相同的两列格式
- ✅ 信息完整：显示完整的字段名和值
- ✅ 易于阅读：字段名左对齐，值右对齐，一目了然
- ✅ 专业性强：符合专业交易系统的展示规范

---

## [2.4.7] - 2026-02-01

### 🎨 边框样式增强优化

**优化内容：**

1. **边框加粗**：所有表格使用 `box.HEAVY` 样式，边框更粗更醒目
2. **撤销订单边框改色**：从灰色改为红色，警示性更强
3. **简化表头**：修改订单和撤销订单表格去除"字段/值"表头行，更简洁

**边框颜色规范：**
- **购买订单（BUY）**：🔵 蓝色粗体边框 `bold blue`
- **售卖订单（SELL）**：🟢 绿色粗体边框 `bold green`
- **修改订单（MODIFY）**：🟡 黄色粗体边框 `bold yellow`
- **撤销订单（CANCEL）**：🔴 红色粗体边框 `bold red`

**效果对比：**
```
修改前（细边框）：
┌────────────────┐
│ 订单信息       │
└────────────────┘

修改后（粗边框）：
┏━━━━━━━━━━━━━━━━┓
┃ 订单信息       ┃
┗━━━━━━━━━━━━━━━━┛
```

**修改订单表格（去除表头）：**
```
修改前：
┏━━━━━━┳━━━━━━┳━━━━━━┓
┃ 字段 ┃ 原值 ┃ 新值 ┃  ← 表头行
┡━━━━━━╇━━━━━━╇━━━━━━┩
│ 数量 │ 1    │ 1 → 3│
└──────┴──────┴──────┘

修改后：
┏━━━━━━┳━━━━━━┳━━━━━━┓
┃ 数量 ┃ 1    ┃ 1 → 3┃  ← 直接显示内容
┗━━━━━━┻━━━━━━┻━━━━━━┛
```

**优势：**
- ✅ 粗边框更醒目，视觉冲击力更强
- ✅ 红色边框警示撤销操作，降低误操作风险
- ✅ 去除冗余表头，表格更简洁高效
- ✅ 统一的粗线样式，提升专业性

---

## [2.4.6] - 2026-02-01

### 🎨 订单表格彩色边框优化

**优化内容：**
为不同类型的订单表格添加彩色粗体边框，增强视觉识别度：

- **购买订单（BUY）**：蓝色粗体边框 `bold blue`
- **售卖订单（SELL）**：绿色粗体边框 `bold green`
- **修改订单（MODIFY）**：黄色粗体边框 `bold yellow`
- **撤销订单（CANCEL）**：灰色粗体边框 `bold bright_black`

**修改的函数：**
- `print_order_table()` - 订单提交表（蓝色/绿色边框）
- `print_order_search_table()` - 订单查询表（蓝色/绿色边框）
- `print_order_modify_table()` - 订单修改表（黄色边框）
- `print_order_cancel_table()` - 订单撤销表（灰色边框）

**效果展示：**
```
购买订单：
╔════════════════════════════╗  ← 蓝色粗体边框
║ AAPL 260207 $250 CALL      ║
║ BUY × 2 @ $5.00            ║
╚════════════════════════════╝

售卖订单：
╔════════════════════════════╗  ← 绿色粗体边框
║ TSLA 260214 $250 PUT       ║
║ SELL × 1 @ $4.50           ║
╚════════════════════════════╝

修改订单：
╔════════════════════════════╗  ← 黄色粗体边框
║ 订单修改详情               ║
╚════════════════════════════╝

撤销订单：
╔════════════════════════════╗  ← 灰色粗体边框
║ 订单撤销信息               ║
╚════════════════════════════╝
```

**优势：**
- ✅ 视觉区分度更高：不同操作类型一目了然
- ✅ 快速识别：通过颜色快速判断订单类型
- ✅ 专业美观：提升界面的专业性和美观度
- ✅ 减少误操作：颜色提醒降低操作失误风险

---

## [2.4.5] - 2026-02-01

### 🐛 修复 Decimal 类型错误

**问题描述：**
在计算订单总价时，由于 `price` 和 `quantity` 可能是 `Decimal` 类型，与 `int` 类型的乘数相乘时会抛出类型错误：
```
unsupported operand type(s) for *: 'float' and 'decimal.Decimal'
```

**修复内容：**
- 在 `format_total_value()` 函数中，将 `price` 和 `quantity` 强制转换为 `float` 类型
- 在 `print_order_modify_table()` 中的总价计算，同样进行类型转换
- 在简洁视图的总价计算中添加类型转换

**修复代码：**
```python
# 修复前
total = price * quantity * multiplier

# 修复后
total = float(price) * float(quantity) * multiplier
```

**影响范围：**
- ✅ 订单提交显示
- ✅ 订单查询显示
- ✅ 订单修改对比
- ✅ 订单撤销显示
- ✅ 订单列表汇总

---

## [2.4.4] - 2026-02-01

### 💰 订单价格和总价分离显示优化

**优化内容：**
- 将价格信息拆分为两个独立字段：**价格**（单价）和 **总价**（合约总价值）
- 新增 `format_total_value()` 函数，计算并格式化总价（单价 × 数量 × 100）
- 总价在所有表格中默认显示为**蓝色粗体**，提升可读性
- 订单修改表中，总价变更时显示为**黄色粗体**高亮

**效果对比：**
```
修改前：
│ 价格         │ $5.00 x 100 = $500.00                    │

修改后：
│ 价格         │ $5.00                                    │
│ 总价         │ $1000.00                                 │ ← 蓝色显示
```

**订单修改表对比：**
```
┃ 字段         ┃ 原值                 ┃ 新值                 ┃
┃ 价格         ┃ $5.00                ┃ $5.00 → $4.50        ┃
┃ 总价         ┃ $500.00              ┃ $500.00 → $1350.00   ┃ ← 黄色高亮
```

**订单列表汇总新增总价列：**
```
┃ 期权                 ┃ 方向 ┃ 数量 ┃ 价格   ┃ 总价      ┃ 策略      ┃
┃ AAPL 260207 $250 CALL┃ BUY  ┃ 2    ┃ $5.00  ┃ $1000.00  ┃ 止损: ... ┃
```

**优势：**
- ✅ 信息更清晰：价格和总价分离展示，一目了然
- ✅ 视觉突出：总价使用蓝色粗体，一眼看到合约价值
- ✅ 变更明显：修改表中总价变更黄色高亮，快速识别影响
- ✅ 专业性强：符合金融交易界面的专业展示习惯

---

## [2.4.3] - 2026-02-01

### 💰 订单价格显示优化

**优化内容：**
- 所有订单表格的价格栏现在显示完整的计算公式：`单价 x 合约乘数 = 总价值`
- 新增 `format_price()` 函数统一处理价格格式化
- 自动显示期权合约乘数（标准为 100）和每份合约的总价值

**效果对比：**
```
修改前：
│ 价格         │ $5.00                                    │

修改后：
│ 价格         │ $5.00 x 100 = $500.00                    │
```

**修改对比表格：**
```
┃ 字段         ┃ 原值                 ┃ 新值                 ┃
┃ 价格         ┃ $5.00 x 100 =        ┃ $5.00 x 100 =        ┃
┃              ┃ $500.00              ┃ $500.00 → $4.50 x    ┃
┃              ┃                      ┃ 100 = $450.00        ┃
```

**优势：**
- 用户一眼就能看到每份合约的实际价值
- 避免手动计算单价 × 100
- 提升专业性和可读性

---

## [2.4.2] - 2026-02-01

### 📊 订单表格标题统一优化

**优化内容：**
- 统一所有单订单表格标题使用期权语义化名称
- `print_order_table()` 和 `print_order_search_table()` 现在与 `print_order_cancel_table()` 和 `print_order_modify_table()` 保持一致的标题格式
- 标题显示格式：`AAPL 260207 $250 CALL` 而不是通用的 "订单详情" 或 "订单查询"

**效果对比：**
```
修改前：
                         订单详情                          
┌──────────────┬──────────────────────────────────────────┐
│ 订单ID       │ 1202595745459367936                      │
│ 期权         │ AAPL 260202 $252.5 CALL                  │
...

修改后：
                   AAPL 260202 $252.5 CALL                   
┌──────────────┬──────────────────────────────────────────┐
│ 订单ID       │ 1202595745459367936                      │
│ 期权         │ AAPL 260202 $252.5 CALL                  │
...
```

**优势：**
- 提升表格的可读性和专业性
- 用户一眼就能识别是哪个期权的订单
- 所有订单相关表格格式保持一致

---

## [2.4.1] - 2026-02-01

### 📊 订单表格格式优化

#### 单个订单表格改为垂直两列格式

**修改的函数：**
- `print_order_table()` - 订单详情表
- `print_order_search_table()` - 订单查询表
- `print_order_cancel_table()` - 订单撤销表
- `print_order_modify_table()` - 订单修改表
- `print_account_info_table()` - 账户信息表

**新格式特性：**
```
                买入订单详情                
┏━━━━━━━━━━━━━━┳━━━━━━━━━━━━━━━━━━━━━━━━━━━┓
┃ 字段         ┃ 值                        ┃
┡━━━━━━━━━━━━━━╇━━━━━━━━━━━━━━━━━━━━━━━━━━━┩
│              │   AAPL 260207 $250 CALL   │ ← 表格内第一行显示语义化期权名称
├──────────────┼───────────────────────────┤
│ 订单ID       │ 1202580174474850304       │
├──────────────┼───────────────────────────┤
│ 期权名称     │ AAPL260207C250000.US      │ ← 仍显示原始代码
├──────────────┼───────────────────────────┤
│ 操作方向     │ BUY                       │
...
```

**期权代码解析增强：**
- 支持 6 位价格格式：`AAPL260207C250000.US`
- 支持 8 位价格格式：`AAPL260207C00250000.US`
- 语义化输出格式：`TICKER YYMMDD $PRICE CALL/PUT`
- 示例：`AAPL260207C250000.US` → `AAPL 260207 $250 CALL`
- 语义化名称显示在表格内第一行，居中对齐

**表格样式改进：**
- 启用行分隔线（`show_lines=True`），视觉更清晰
- 语义化期权名称采用青色粗体（`bold cyan`），醒目突出

**保持不变：**
- ✅ 订单列表汇总（`print_orders_summary_table()`）仍为横向多列格式
- ✅ 持仓信息列表（`print_positions_table()`）仍为横向多列格式

**影响范围：**
- 订单提交、查询、修改、撤销的输出格式
- 账户信息展示

---

## [2.4.0] - 2026-02-01

### 新增功能 - SEARCH 查询操作标识 🔍

#### 订单查询操作
- ✅ **新增 SEARCH 操作类型**
  - 专门用于标识订单查询操作
  - 使用蓝色（bold blue）标识
  - 与 BUY/SELL/CANCEL 并列的操作类型

- ✅ **订单查询专用表格**
  - 新增 `print_order_search_table()` 函数
  - **操作类型**：显示 SEARCH（蓝色）
  - **订单方向**：显示原始的 BUY/SELL（保持原色）
  - **已成交数量**：显示 executed_quantity
  - **提交时间**：显示 submitted_at

- ✅ **完整的操作类型体系**
  ```
  BUY    (买入) → 绿色 ✅
  SELL   (卖出) → 红色 ❌
  SEARCH (查询) → 蓝色 🔍  ⭐ 新增
  CANCEL (撤销) → 黄色 ⚠️
  ```

#### 显示效果

**查询订单时的输出：**
```
✅ 找到订单
                     订单查询                     
┏━━━━━━━━━━━━━━┳━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━┓
┃ 字段         ┃ 值                              ┃
┡━━━━━━━━━━━━━━╇━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━┩
│ 订单ID       │ 1202583663460507648             │
│ 期权名称     │ AAPL260202C252500.US            │
│ 操作类型     │ SEARCH                          │ ← 蓝色
│ 订单方向     │ BUY                             │ ← 绿色
│ 数量         │ 2                               │
│ 已成交       │ 0                               │
│ 价格         │ $4.50                           │
│ 策略         │ -                               │
│ 状态         │ OrderStatus.ReplacedNotReported │
│ 提交时间     │ 2026-02-01T19:58:08             │
│ 账户模式     │ 🧪 模拟账户                     │
└──────────────┴─────────────────────────────────┘
```

### 技术实现

- 修改 `broker/order_formatter.py`:
  - `format_side()` 函数添加 SEARCH 支持
  - 新增 `print_order_search_table()` 函数

- 修改 `test/broker/test_order_management.py`:
  - `test_get_order_detail()` 使用新的查询表格

- 更新 `demo_order_format.py`:
  - 新增场景 3：订单查询（SEARCH - 蓝色）
  - 更新场景编号
  - 更新说明文档

### 文档更新

- 新增 `SEARCH_OPERATION_UPDATE.md` - SEARCH 操作详细说明
- 更新演示脚本的颜色说明

### 设计理念

**清晰的语义区分：**
- **操作类型（SEARCH）**：表示"当前操作是查询"
- **订单方向（BUY/SELL）**：表示"订单本身的方向"

这样设计可以：
1. 清晰区分"查询动作"和"订单属性"
2. 保持信息完整性
3. 视觉层次分明

---

## [2.3.0] - 2026-02-01

### 新增功能 - 彩色表格输出 ⭐

#### 订单格式化输出
- ✅ **彩色表格展示订单信息**
  - BUY (买入) - 绿色粗体 ✅
  - SELL (卖出) - 红色粗体 ❌
  - CANCEL (撤销) - 黄色粗体 ⚠️
  
- ✅ **订单详情表**
  - 订单ID
  - 期权名称
  - 操作方向（彩色标识）
  - 数量
  - 价格
  - 策略（止盈止损规则）
  - 状态
  - 账户模式

- ✅ **订单修改对比表** (优化)
  - **只显示有变更的字段**（更简洁）
  - 修改项用箭头表示（如 `1 → 2`）
  - 新值列黄色高亮
  - 底部显示修改统计（如 `共修改 2 个字段`）
  - 订单ID和期权名称始终显示

- ✅ **订单撤销表**
  - 黄色 CANCEL 标识
  - 显示被撤销的订单详情
  - 撤销时间

- ✅ **订单列表汇总表**
  - 紧凑的多订单展示
  - 每个订单一行
  - 彩色方向标识

- ✅ **策略自动格式化**
  - 固定止损: `止损: $3.00`
  - 跟踪止损: `跟踪止损: 5.0%`
  - 跟踪金额: `跟踪金额: $2.00`
  - 组合显示

### 技术实现

- 新增模块: `broker/order_formatter.py`
- 集成到: `broker/longport_broker.py`
- 依赖: `rich>=13.0.0`

### 文档

- ✅ `docs/order_format_guide.md` - 格式化输出完整指南
- ✅ `demo_order_format.py` - 演示脚本

### 示例输出

```
✅ 订单提交成功
                 订单详情                  
┏━━━━━━━━━━━━━━┳━━━━━━━━━━━━━━━━━━━━━━┓
┃ 字段         ┃ 值                   ┃
┡━━━━━━━━━━━━━━╇━━━━━━━━━━━━━━━━━━━━━━┩
│ 订单ID       │ 1202580174474850304  │
│ 期权名称     │ AAPL260207C250000.US │
│ 操作方向     │ BUY                  │ (绿色)
│ 数量         │ 2                    │
│ 价格         │ $5.00                │
│ 策略         │ 止损: $3.00          │
│ 状态         │ submitted            │
│ 账户模式     │ 🧪 模拟账户          │
└──────────────┴──────────────────────┘
```

---

## [2.2.0] - 2026-02-01

### 新增功能

#### 期权链查询
- ✅ `get_option_expiry_dates()` - 获取期权到期日列表
- ✅ `get_option_chain_info()` - 获取指定到期日的期权链（行权价、期权代码）
- ✅ `get_option_quote()` - 获取期权实时报价

#### 订单管理
- ✅ `cancel_order()` - 撤销订单
- ✅ `replace_order()` - 修改订单（价格、数量）
- ✅ 订单支持止盈止损参数：
  - `trigger_price` - 固定止损触发价
  - `trailing_percent` - 跟踪止损百分比
  - `trailing_amount` - 跟踪止损金额

### 功能增强

#### submit_option_order() 方法增强
新增参数：
```python
submit_option_order(
    symbol,
    side,
    quantity,
    price=None,
    order_type="LIMIT",
    remark="",
    trigger_price=None,        # ⭐ 新增
    trailing_percent=None,     # ⭐ 新增
    trailing_amount=None       # ⭐ 新增
)
```

### 测试
- ✅ `test/broker/test_order_management.py` - 订单管理功能完整测试
- ✅ `test/broker/test_longport_integration.py` - 更新集成测试，包含期权链查询

### 文档
- ✅ `docs/order_management.md` - 订单管理功能完整文档
- ✅ `README.md` - 更新功能特性说明
- ✅ `CHANGELOG.md` - 本更新日志

### 错误修复
- 🐛 修复期权代码转换中的日期解析问题
- 🐛 修复期权链查询 API 属性名问题（price vs strike_price）
- 🐛 修复订单撤销返回值处理

### 已验证功能
所有功能已在模拟账户中测试通过：
- ✅ 期权链查询（26个到期日，41个行权价）
- ✅ 期权实时报价（最新价、开盘、最高、最低、成交量）
- ✅ 带止损的订单提交
- ✅ 跟踪止损订单
- ✅ 订单修改
- ✅ 订单撤销
- ✅ 订单状态查询

---

## [2.1.0] - 2026-01-XX

### 新增功能
- ✅ Cookie 持久化
- ✅ 智能去重（内容哈希 + 消息ID）
- ✅ 自动滚动支持
- ✅ 后台监控工具
- ✅ 长桥证券集成
- ✅ 风险控制模块
- ✅ 持仓管理系统

---

## 使用指南

### 快速测试新功能

#### 1. 测试期权链查询

```bash
cd /Users/txink/Documents/code/playwright
PYTHONPATH=$(pwd) python3 test/broker/test_longport_integration.py
```

查看输出中的"测试 5: 期权链查询"部分。

#### 2. 测试订单管理

```bash
PYTHONPATH=$(pwd) python3 test/broker/test_order_management.py
```

此测试会演示：
- 带止损的订单提交
- 跟踪止损订单
- 订单修改
- 订单撤销

#### 3. 使用新功能

```python
from broker import LongPortBroker, load_longport_config

# 初始化
config = load_longport_config()
broker = LongPortBroker(config)

# 1. 查询期权链
expiry_dates = broker.get_option_expiry_dates("AAPL.US")
option_chain = broker.get_option_chain_info("AAPL.US", expiry_dates[1])

# 2. 提交带止损的订单
order = broker.submit_option_order(
    symbol=option_chain["call_symbols"][20],
    side="BUY",
    quantity=2,
    price=5.0,
    trigger_price=3.0,  # 止损价 $3
    remark="带止损的买入订单"
)

# 3. 修改订单
broker.replace_order(
    order_id=order['order_id'],
    quantity=3,
    price=4.5
)

# 4. 撤销订单
broker.cancel_order(order['order_id'])
```

### 详细文档

- 📖 [订单管理完整文档](./docs/order_management.md)
- 📖 [长桥集成指南](./doc/LONGPORT_INTEGRATION_GUIDE.md)
- 📖 [配置说明](./doc/CONFIGURATION.md)

---

## 贡献者

感谢所有贡献者的付出！

---

## 许可证

MIT License
