# CHANGELOG

## [2026-02-02 v2] 输出格式优化 - 独立表格展示和环境变量控制

### ✅ 新增功能

#### 1. 独立表格式输出（使用Rich Table组件）
使用Python `rich`库的Table组件，每个指令使用独立的表格卡片展示：

**特点**：
- 🎨 美观的圆角边框（ROUNDED box style）
- 🎯 标题颜色区分（成功=绿色，失败=红色）
- 📐 自动对齐和格式化
- 💡 结构化字段展示

```
                                 #4 BUY - LYFT                                  
╭────────────────────┬─────────────────────────────────────────────────────────╮
│ 字段               │ 值                                                      │
├────────────────────┼─────────────────────────────────────────────────────────┤
│ 时间               │ Jan 12, 2026 11:40 PM                                   │
│ 期权代码           │ LYFT                                                    │
│ 指令类型           │ BUY                                                     │
│ 状态               │ ✅                                                      │
│ 期权类型           │ CALL                                                    │
│ 行权价             │ $19.5                                                   │
│ 到期日             │ 1/23                                                    │
│ 价格               │ $0.58                                                   │
│ 仓位大小           │ 小仓位                                                  │
│ 原始消息           │ LYFT 19.5c 1/23 0.58-0.62 日内交易小仓位                │
╰────────────────────┴─────────────────────────────────────────────────────────╯

统计信息表格：
                                  📊 解析统计                                   
╔══════════════════════════════════════════════════════════════════════════════╗
║ 总消息数: 91 | 成功: 64 | 失败: 27 | 成功率: 70.3%                           ║
╚══════════════════════════════════════════════════════════════════════════════╝
```

#### 2. 环境变量控制
新增 `SHOW_PARSER_OUTPUT` 环境变量控制Parser层输出：

```bash
# 显示Parser解析输出（默认）
python3 analyze_local_messages.py debug/page.html

# 隐藏Parser解析输出（适用于broker下单场景）
SHOW_PARSER_OUTPUT=false python3 analyze_local_messages.py debug/page.html
```

**支持的值**: `true`, `false`, `1`, `0`, `yes`, `no`  
**默认值**: `true`

#### 3. 配置文件模板
新增 `.env.example` 配置文件模板：
- Parser层输出控制
- Broker层配置预留（价格偏差、仓位大小等）

### 📋 使用场景

**场景1：调试Parser解析**
```bash
# 显示详细解析结果
SHOW_PARSER_OUTPUT=true python3 analyze_local_messages.py data.html
```

**场景2：Broker实际下单**
```bash
# 隐藏Parser输出，只显示broker下单信息
SHOW_PARSER_OUTPUT=false python3 broker_trade.py
```

### 📊 输出改进

**改进前**：
```
 Jan 12, 2026 11:40 PM  LYFT     ✅ [解析成功] [买入] LYFT $19.5 CALL @ $0.58 (1/23) 小仓位
 Jan 12, 2026 11:44 PM  未识别      ✅ [解析成功] [卖出] 未识别 @ $0.7 数量: 1/2
```

**改进后**：
```
时间                       代码       状态     类型       详情
--------------------------------------------------------------------------------------------------------------------------------------------
Jan 12, 2026 11:40 PM    LYFT     ✅      BUY      [买入] LYFT $19.5 CALL @ $0.58 (1/23) 小仓位
Jan 12, 2026 11:44 PM    未识别      ✅      SELL     [卖出] 未识别 @ $0.7 数量: 1/2
```

### 🎯 优势

- ✅ 更清晰的列对齐
- ✅ 直观的指令类型展示（BUY/SELL/CLOSE/MODIFY）
- ✅ 减少视觉干扰（移除"解析成功"标签）
- ✅ 易于扫描和过滤
- ✅ 支持环境变量控制，避免输出冲突

---

## [2026-02-02 v1] Parser层重构 - 支持Broker接口标准

### ✅ 重大改进

#### 1. 重新设计数据模型
- 重构 `InstructionType` 枚举：
  - `OPEN` → `BUY`（买入）
  - `TAKE_PROFIT` → `SELL`（卖出部分）
  - 新增 `CLOSE`（清仓全部）
  - `STOP_LOSS` + `ADJUST` → `MODIFY`（修改止损/止盈）

#### 2. 新增字段支持

**价格字段**：
- `price`: 单价（区间时为中间值）
- `price_range`: 价格区间 [min, max]
- 支持解析价格范围（如 0.83-0.85）

**卖出数量字段**：
- `sell_quantity`: 支持多种格式
  - "100" - 具体股数
  - "1/3", "1/2", "2/3" - 比例（相对于最初买入仓位）
  - "30%" - 百分比（相对于最初买入仓位）

**修改指令字段**：
- `stop_loss_price` / `stop_loss_range`: 止损价格
- `take_profit_price` / `take_profit_range`: 止盈价格

#### 3. 解析能力增强

**买入指令**：
- ✅ 支持价格区间解析（0.83-0.85 → [0.83, 0.85]）
- ✅ 支持相对日期转换（今天、本周、下周 → 具体日期）
- ✅ 自动识别仓位大小（小仓位、中仓位、大仓位）

**卖出指令**：
- ✅ 智能区分部分卖出（SELL）和清仓（CLOSE）
- ✅ 解析多种数量格式（1/3, 30%, 100, 全部）
- ✅ 支持价格区间

**修改指令**：
- ✅ 合并止损和调整止损逻辑
- ✅ 支持价格区间

#### 4. 输出格式改进

**命令行输出**：
```
时间                    期权代码    状态       指令内容
Jan 12, 2026 11:40 PM  LYFT     ✅ [买入] LYFT $19.5 CALL @ $0.58 (1/23) 小仓位
Jan 12, 2026 11:44 PM  未识别    ✅ [卖出] 未识别 @ $0.7 数量: 1/2
Jan 13, 2026 10:59 PM  未识别    ✅ [清仓] 未识别 @ $0.92
Jan 20, 2026 10:37 PM  未识别    ✅ [修改] 未识别 止损: $1.0
```

### 📊 性能指标

- **解析成功率**: 70.3% (64/91)
- **支持格式数**: 10+ 种不同的消息格式
- **价格区间支持**: 100%
- **卖出数量格式**: 支持4种（具体数量、比例、百分比、全部）

### 🔄 职责分工

**Parser层**：
- ✅ 解析消息文本
- ✅ 提取结构化数据
- ✅ 识别指令类型
- ✅ 解析价格区间
- ✅ 解析卖出数量格式
- ✅ 转换相对日期

**Broker层**（待实现）：
- ⚠️ 确定具体买入数量
- ⚠️ 计算具体卖出数量
- ⚠️ 验证价格合理性
- ⚠️ 选择最优价格
- ⚠️ 执行实际交易

### 📝 文档更新

新增文档：
- `PARSER_DATA_MODEL.md` - Parser层数据模型规范
- `IMPLEMENTATION_PROGRESS.md` - 实现进度跟踪

### 🐛 已知问题

1. 部分特殊格式未支持：
   - `$XOM 1/16 $127 call 0.8-0.85` (日期在行权价前)
   - `SPY - $680 CALLS 今天 $2.3` ("今天"关键词)
   - `APLD - $40 CALLS下周的 $1.28` ("下周的"格式)

2. 卖出/修改指令ticker显示为"未识别"
   - 原因：这些消息不包含ticker信息
   - 解决方案：需要从上下文或分组信息中提取

### 🎯 下一步计划

1. 完善剩余开仓格式解析
2. 从消息上下文中提取ticker信息
3. 实现Broker层价格验证逻辑
4. 添加价格范围选择策略
5. 实现持仓管理和数量计算

---

## 历史记录

### [2026-02-02] 初始实现
- 实现基本的消息提取和分组功能
- 支持多种期权消息格式解析
- 实现流式处理和实时输出
